name: manylinux-wheels

on:
  push:
    branches: [ main ]
  pull_request:
  workflow_dispatch:

jobs:
  build-manylinux:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        py_tag: ["cp311-cp311", "cp312-cp312"]
        py_ver: ["3.11", "3.12"]
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Pull manylinux image
        run: docker pull quay.io/pypa/manylinux2014_x86_64

      - name: Build wheels in manylinux
        run: |
          docker run --rm -v $PWD:/work -w /work quay.io/pypa/manylinux2014_x86_64 /bin/bash -lc '
            set -euo pipefail
            PYBIN=/opt/python/${{ matrix.py_tag }}/bin/python
            export PIP_ROOT_USER_ACTION=ignore
            $PYBIN -m pip install --upgrade pip
            $PYBIN -m pip install cmake ninja pybind11 setuptools wheel auditwheel
            # Ensure compilers and tools are available; handle MANPATH under set -u
            export MANPATH=${MANPATH-""}
            set +u
            if [ -f /opt/rh/devtoolset-10/enable ]; then source /opt/rh/devtoolset-10/enable; elif [ -f /opt/rh/devtoolset-9/enable ]; then source /opt/rh/devtoolset-9/enable; fi
            set -u
            export PATH="$(dirname "$PYBIN"):$PATH"
            gcc --version || true
            cmake --version || true
            ninja --version || true
            P11_DIR=$($PYBIN -c "import pybind11,sys; print(pybind11.get_cmake_dir())")
            BUILD_DIR=/work/build-${{ matrix.py_tag }}
            cmake -S /work -B ${BUILD_DIR} -G Ninja -DCMAKE_BUILD_TYPE=Release -DTAS_CLIENT_API_BUILD_PYTHON=ON -DPython_EXECUTABLE=$PYBIN -Dpybind11_DIR="$P11_DIR"
            cmake --build ${BUILD_DIR} --target python_package -j"$(nproc)"
            mkdir -p /work/dist
            auditwheel repair -w /work/dist ${BUILD_DIR}/python/dist/*.whl || true
          '

      - name: Upload repaired wheels
        uses: actions/upload-artifact@v4
        with:
          name: PyTAS-manylinux-${{ matrix.py_ver }}
          path: dist/*.whl

      - name: Upload raw .so extensions
        uses: actions/upload-artifact@v4
        with:
          name: PyTAS-manylinux-${{ matrix.py_ver }}-so
          path: build-*/python/src/PyTAS/*.so
