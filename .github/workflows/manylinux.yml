name: manylinux-wheels

on:
  push:
    branches: [ main ]
  pull_request:
  workflow_dispatch:

jobs:
  build-manylinux:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Pull manylinux image
        run: docker pull quay.io/pypa/manylinux2014_x86_64

      - name: Build wheels in manylinux
        run: |
          docker run --rm -v $PWD:/work -w /work quay.io/pypa/manylinux2014_x86_64 /bin/bash -lc '
            set -euxo pipefail
            for PYBIN in /opt/python/cp311-cp311/bin/python /opt/python/cp312-cp312/bin/python; do
              $PYBIN -m pip install --upgrade pip
              $PYBIN -m pip install cmake ninja pybind11 setuptools wheel auditwheel
              # Ensure compilers and tools are available
              if [ -f /opt/rh/devtoolset-10/enable ]; then source /opt/rh/devtoolset-10/enable; elif [ -f /opt/rh/devtoolset-9/enable ]; then source /opt/rh/devtoolset-9/enable; fi
              export PATH="$(dirname "$PYBIN"):$PATH"
              gcc --version || true
              cmake --version || true
              ninja --version || true
              P11_DIR=$($PYBIN -c "import pybind11,sys; print(pybind11.get_cmake_dir())")
              VTAG=$($PYBIN -c "import sys;print(f\"cp{sys.version_info.major}{sys.version_info.minor}-cp{sys.version_info.major}{sys.version_info.minor}\")")
              BUILD_DIR=/work/build-${VTAG}
              cmake -S /work -B ${BUILD_DIR} -G Ninja -DCMAKE_BUILD_TYPE=Release -DTAS_CLIENT_API_BUILD_PYTHON=ON -DPython_EXECUTABLE=$PYBIN -Dpybind11_DIR="$P11_DIR"
              cmake --build ${BUILD_DIR} --target python_package -j"$(nproc)"
              mkdir -p /work/dist
              auditwheel repair -w /work/dist ${BUILD_DIR}/python/dist/*.whl || true
            done
          '

      - name: Upload repaired wheels
        uses: actions/upload-artifact@v4
        with:
          name: PyTAS-manylinux-wheels
          path: dist/*.whl
