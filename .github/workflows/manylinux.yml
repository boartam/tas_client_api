name: manylinux-wheels

on:
  push:
    branches: [ main ]
  pull_request:
  workflow_dispatch:

jobs:
  prepare-matrix:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.gen.outputs.matrix }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - id: gen
        name: Generate matrix from .github/python-versions.json
        run: |
          JSON=$(jq -c '{ "py_ver": . }' .github/python-versions.json)
          echo "matrix=$JSON" >> $GITHUB_OUTPUT

  build-manylinux:
    needs: prepare-matrix
    runs-on: ubuntu-latest
    strategy:
      matrix: ${{ fromJSON(needs.prepare-matrix.outputs.matrix) }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Extract project version from CMakeLists.txt
        run: |
          VERSION=$(python3 -c "import re,sys,io; s=io.open('CMakeLists.txt','r',encoding='utf-8').read(); m=re.search(r'project\\s*\\(\\s*tas_client_api[\\s\\S]*?VERSION\\s*([0-9]+(?:\\.[0-9]+)*)', s, re.IGNORECASE|re.DOTALL); print(m.group(1)) if m else sys.exit('VERSION not found in CMakeLists.txt')")
          echo "PKG_VERSION=$VERSION" >> $GITHUB_ENV

      - name: Compute short commit SHA
        run: |
          SHORT_SHA=$(echo "$GITHUB_SHA" | cut -c1-7)
          echo "SHORT_SHA=$SHORT_SHA" >> $GITHUB_ENV

      - name: Pull manylinux image
        run: docker pull quay.io/pypa/manylinux2014_x86_64

      - name: Build wheels in manylinux
        run: |
          docker run --rm -v $PWD:/work -w /work quay.io/pypa/manylinux2014_x86_64 /bin/bash -lc '
            set -euo pipefail
            PV="${{ matrix.py_ver }}"
            PTAG=$(echo "$PV" | tr -d '.')
            PYBIN=/opt/python/cp${PTAG}-cp${PTAG}/bin/python
            export PIP_ROOT_USER_ACTION=ignore
            $PYBIN -m pip install --upgrade pip
            $PYBIN -m pip install cmake ninja pybind11 setuptools wheel auditwheel
            # Ensure compilers and tools are available; handle MANPATH under set -u
            export MANPATH=${MANPATH-""}
            set +u
            if [ -f /opt/rh/devtoolset-10/enable ]; then source /opt/rh/devtoolset-10/enable; elif [ -f /opt/rh/devtoolset-9/enable ]; then source /opt/rh/devtoolset-9/enable; fi
            set -u
            export PATH="$(dirname "$PYBIN"):$PATH"
            gcc --version || true
            cmake --version || true
            ninja --version || true
            P11_DIR=$($PYBIN -c "import pybind11,sys; print(pybind11.get_cmake_dir())")
            BUILD_DIR=/work/build-cp${PTAG}
            cmake -S /work -B ${BUILD_DIR} -G Ninja -DCMAKE_BUILD_TYPE=Release -DTAS_CLIENT_API_BUILD_PYTHON=ON -DPython_EXECUTABLE=$PYBIN -Dpybind11_DIR="$P11_DIR"
            cmake --build ${BUILD_DIR} --target python_package -j"$(nproc)"
            mkdir -p /work/dist
            auditwheel repair -w /work/dist ${BUILD_DIR}/python/dist/*.whl || true
          '

      - name: Upload combined wheel + so artifact
        uses: actions/upload-artifact@v4
        with:
          name: PyTAS-${{ env.PKG_VERSION }}.${{ env.SHORT_SHA }}-${{ matrix.py_ver }}-linux
          path: |
            dist/*.whl
            build-*/python/src/PyTAS/*.so
