name: build-wheels

on:
  push:
    branches: [ main ]
    tags:
      - "v*"
  pull_request:
  workflow_dispatch:
    inputs:
      tag:
        description: "Package tag for validation (e.g., v1.0.12)"
        required: false
        default: ""

jobs:
  prepare:
    runs-on: ubuntu-latest
    outputs:
      versions: ${{ steps.out.outputs.versions }}
      version: ${{ steps.out.outputs.version }}
      short_sha: ${{ steps.out.outputs.short_sha }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Compute outputs (versions, version, short_sha)
        id: out
        run: |
          set -euo pipefail
          VERS=$(cat .github/python-versions.json)
          echo "versions=$VERS" >> $GITHUB_OUTPUT
          VERSION=$(python3 -c "import re,sys,io; s=io.open('CMakeLists.txt','r',encoding='utf-8').read(); m=re.search(r'project\\s*\\(\\s*tas_client_api[\\s\\S]*?VERSION\\s*([0-9]+(?:\\.[0-9]+)*)', s, re.IGNORECASE|re.DOTALL); print(m.group(1)) if m else sys.exit('VERSION not found in CMakeLists.txt')")
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          SHORT_SHA=$(echo "$GITHUB_SHA" | cut -c1-7)
          echo "short_sha=$SHORT_SHA" >> $GITHUB_OUTPUT

  build-manylinux:
    needs: prepare
    runs-on: ubuntu-latest
    env:
      PKG_VERSION: ${{ needs.prepare.outputs.version }}
      SHORT_SHA: ${{ needs.prepare.outputs.short_sha }}
    strategy:
      matrix:
        py_ver: ${{ fromJSON(needs.prepare.outputs.versions) }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Pull manylinux image
        run: docker pull quay.io/pypa/manylinux2014_x86_64

      - name: Build wheels in manylinux
        run: |
          docker run --rm -v $PWD:/work -w /work quay.io/pypa/manylinux2014_x86_64 /bin/bash -lc '
            set -euo pipefail
            PV="${{ matrix.py_ver }}"
            PTAG=$(echo "$PV" | tr -d '.')
            PYBIN=/opt/python/cp${PTAG}-cp${PTAG}/bin/python
            export PIP_ROOT_USER_ACTION=ignore
            $PYBIN -m pip install --upgrade pip
            $PYBIN -m pip install cmake ninja pybind11 setuptools wheel auditwheel
            export MANPATH=${MANPATH-""}
            set +u
            if [ -f /opt/rh/devtoolset-10/enable ]; then source /opt/rh/devtoolset-10/enable; elif [ -f /opt/rh/devtoolset-9/enable ]; then source /opt/rh/devtoolset-9/enable; fi
            set -u
            export PATH="$(dirname "$PYBIN"):$PATH"
            P11_DIR=$($PYBIN -c "import pybind11,sys; print(pybind11.get_cmake_dir())")
            BUILD_DIR=/work/build-cp${PTAG}
            cmake -S /work -B ${BUILD_DIR} -G Ninja -DCMAKE_BUILD_TYPE=Release -DTAS_CLIENT_API_BUILD_PYTHON=ON -DPython_EXECUTABLE=$PYBIN -Dpybind11_DIR="$P11_DIR"
            cmake --build ${BUILD_DIR} --target python_package -j"$(nproc)"
            mkdir -p /work/dist
            auditwheel repair -w /work/dist ${BUILD_DIR}/python/dist/*.whl || true
          '

      - name: Upload internal wheel + so (manylinux)
        uses: actions/upload-artifact@v4
        with:
          name: _tmp-PyTAS-${{ env.PKG_VERSION }}.${{ env.SHORT_SHA }}-${{ matrix.py_ver }}-linux
          retention-days: 1
          compression-level: 0
          path: |
            dist/*.whl
            build-*/python/src/PyTAS/*.so

  build-windows-wheel:
    needs: prepare
    runs-on: windows-latest
    env:
      PKG_VERSION: ${{ needs.prepare.outputs.version }}
      SHORT_SHA: ${{ needs.prepare.outputs.short_sha }}
    strategy:
      matrix:
        python-version: ${{ fromJSON(needs.prepare.outputs.versions) }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
          architecture: x64

      - name: Install build dependencies (CMake, Ninja, pybind11)
        shell: pwsh
        run: |
          python -m pip install --upgrade pip
          pip install cmake ninja pybind11 wheel setuptools

      - name: Export pybind11 CMake dir
        id: p11
        shell: pwsh
        run: |
          $p11 = python -c "import pybind11; print(pybind11.get_cmake_dir())"
          echo "P11_DIR=$p11" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append

      - name: Configure CMake (Windows, Release)
        shell: pwsh
        run: |
          cmake -S . -B build-windows -G "Visual Studio 17 2022" -A x64 -DCMAKE_BUILD_TYPE=Release -DTAS_CLIENT_API_BUILD_PYTHON=ON -Dpybind11_DIR="$env:P11_DIR"

      - name: Build Python wheel via CMake target
        shell: pwsh
        run: |
          cmake --build build-windows --target python_package --config Release -- /m

      - name: Upload internal wheel + pyd (windows)
        uses: actions/upload-artifact@v4
        with:
          name: _tmp-PyTAS-${{ env.PKG_VERSION }}.${{ env.SHORT_SHA }}-${{ matrix.python-version }}-windows
          retention-days: 1
          compression-level: 0
          path: |
            build-windows/python/dist/*.whl
            build-windows/python/src/PyTAS/*.pyd

  collect:
    needs: [prepare, build-manylinux, build-windows-wheel]
    runs-on: ubuntu-latest
    env:
      PKG_VERSION: ${{ needs.prepare.outputs.version }}
      SHORT_SHA: ${{ needs.prepare.outputs.short_sha }}
      PKG_TAG: ${{ github.event.inputs.tag != '' && github.event.inputs.tag || (startsWith(github.ref, 'refs/tags/') && github.ref_name || github.sha) }}
    steps:
      - name: Validate tag matches project version
        if: startsWith(github.ref, 'refs/tags/') || github.event.inputs.tag != ''
        run: |
          TAG="${{ env.PKG_TAG }}"
          VER="${{ env.PKG_VERSION }}"
          if [ "$TAG" = "v$VER" ] || [ "$TAG" = "$VER" ]; then
            echo "Tag $TAG matches version $VER"
          else
            echo "Error: Tag $TAG does not match version $VER" >&2
            exit 1
          fi

      - name: Download internal manylinux artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: _tmp-PyTAS-${{ env.PKG_VERSION }}.${{ env.SHORT_SHA }}-*-linux
          merge-multiple: true
          path: artifacts/manylinux

      - name: Download internal windows artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: _tmp-PyTAS-${{ env.PKG_VERSION }}.${{ env.SHORT_SHA }}-*-windows
          merge-multiple: true
          path: artifacts/windows

      - name: Assemble dist folder
        run: |
          mkdir -p dist
          find artifacts -name '*.whl' -exec cp {} dist \;
          find artifacts -name '*.pyd' -exec cp {} dist \;
          find artifacts -name '*.so' -exec cp {} dist \;
          echo "Collected files:" && ls -la dist

      - name: Upload combined artifact (wheels + pyd + so)
        uses: actions/upload-artifact@v4
        with:
          name: PyTAS-${{ env.PKG_VERSION }}
          path: dist
