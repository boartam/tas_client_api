name: collect-wheels

on:
  workflow_dispatch:
    inputs:
      repository:
        description: "PyPI repository (pypi or testpypi)"
        required: false
        default: "pypi"
      tag:
        description: "Package tag for artifact naming (e.g., v1.0.12)"
        required: false
        default: ""
  push:
    tags:
      - "v*"

permissions:
  contents: read

jobs:
  collect:
    runs-on: ubuntu-latest
    env:
      PKG_TAG: ${{ github.event.inputs.tag != '' && github.event.inputs.tag || (startsWith(github.ref, 'refs/tags/') && github.ref_name || github.sha) }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install GH CLI
        run: |
          sudo apt-get update -y
          sudo apt-get install -y gh
          python -m pip install --upgrade pip
        env:
          DEBIAN_FRONTEND: noninteractive

      - name: Extract project version from CMakeLists.txt
        run: |
          VERSION=$(python3 -c "import re,sys,io; s=io.open('CMakeLists.txt','r',encoding='utf-8').read(); m=re.search(r'project\\s*\\(\\s*tas_client_api[\\s\\S]*?VERSION\\s*([0-9]+(?:\\.[0-9]+)*)', s, re.IGNORECASE|re.DOTALL); print(m.group(1)) if m else sys.exit('VERSION not found in CMakeLists.txt')")
          echo "PKG_VERSION=$VERSION" >> $GITHUB_ENV

      - name: Validate tag matches project version
        if: startsWith(github.ref, 'refs/tags/') || github.event.inputs.tag != ''
        run: |
          TAG="${{ env.PKG_TAG }}"
          VER="${{ env.PKG_VERSION }}"
          if [ "$TAG" = "v$VER" ] || [ "$TAG" = "$VER" ]; then
            echo "Tag $TAG matches version $VER"
          else
            echo "Error: Tag $TAG does not match version $VER" >&2
            exit 1
          fi

      - name: Read python versions
        id: vers
        run: |
          VERS=$(jq -r '.[]' .github/python-versions.json | tr '\n' ' ')
          echo "list=$VERS" >> $GITHUB_OUTPUT

      - name: Download manylinux combined artifacts (wheel + so)
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          ML_RUN_ID=$(gh run list --workflow manylinux.yml --status success --limit 1 --json databaseId -q '.[0].databaseId')
          mkdir -p artifacts/manylinux
          for PV in ${{ steps.vers.outputs.list }}; do
            NAME=$(gh api repos/${{ github.repository }}/actions/runs/$ML_RUN_ID/artifacts --jq '.artifacts[].name' | grep -E "^PyTAS-${{ env.PKG_VERSION }}\.[a-f0-9]{7}-${PV}-linux$" | head -n1 || true)
            if [ -n "$NAME" ]; then
              gh run download $ML_RUN_ID --name "$NAME" --dir artifacts/manylinux || true
            else
              echo "Warning: No manylinux artifact for Python ${PV} matching version ${{ env.PKG_VERSION }} found" >&2
            fi
          done

      - name: Download windows combined artifacts (wheel + pyd)
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          WIN_RUN_ID=$(gh run list --workflow windows-python.yml --status success --limit 1 --json databaseId -q '.[0].databaseId')
          mkdir -p artifacts/windows
          for PV in ${{ steps.vers.outputs.list }}; do
            NAME=$(gh api repos/${{ github.repository }}/actions/runs/$WIN_RUN_ID/artifacts --jq '.artifacts[].name' | grep -E "^PyTAS-${{ env.PKG_VERSION }}\.[a-f0-9]{7}-${PV}-windows$" | head -n1 || true)
            if [ -n "$NAME" ]; then
              gh run download $WIN_RUN_ID --name "$NAME" --dir artifacts/windows || true
            else
              echo "Warning: No windows artifact for Python ${PV} matching version ${{ env.PKG_VERSION }} found" >&2
            fi
          done

      - name: Assemble dist folder
        run: |
          mkdir -p dist
          find artifacts -name '*.whl' -exec cp {} dist \;
          find artifacts -name '*.pyd' -exec cp {} dist \;
          find artifacts -name '*.so' -exec cp {} dist \;
          echo "Collected wheels:" && ls -la dist

      - name: Upload combined artifact (wheels + pyd + so)
        uses: actions/upload-artifact@v4
        with:
          name: PyTAS-${{ env.PKG_VERSION }}
          path: dist
